<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ML Studio — Youness Mchaar</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #080c14;
    --surface: #0d1525;
    --card: #111c30;
    --border: #1e3050;
    --accent: #00e5ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --warn: #f59e0b;
    --text: #e2eaf6;
    --muted: #4a6080;
    --glow: 0 0 30px rgba(0,229,255,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Sora', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 10;
    padding: 24px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(8,12,20,0.8);
    backdrop-filter: blur(10px);
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .logo span { color: var(--muted); }

  .badge {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border: 1px solid var(--accent);
    color: var(--accent);
    letter-spacing: 1px;
    border-radius: 2px;
    animation: pulse-border 2s infinite;
  }

  @keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 0 0 rgba(0,229,255,0.4); }
    50% { box-shadow: 0 0 0 4px rgba(0,229,255,0); }
  }

  main {
    position: relative;
    z-index: 10;
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px;
  }

  .hero {
    text-align: center;
    padding: 60px 0 50px;
  }

  .hero h1 {
    font-size: clamp(36px, 5vw, 64px);
    font-weight: 800;
    line-height: 1.1;
    background: linear-gradient(135deg, #fff 30%, var(--accent) 70%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
  }

  .hero p {
    color: var(--muted);
    font-size: 15px;
    max-width: 500px;
    margin: 0 auto 40px;
    line-height: 1.7;
    font-weight: 300;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 4px;
    width: fit-content;
    margin: 0 auto 48px;
  }

  .tab {
    padding: 10px 24px;
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    letter-spacing: 1px;
    border: none;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    border-radius: 5px;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .tab.active {
    background: var(--accent);
    color: #000;
    font-weight: 700;
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* Cards */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .card:hover {
    border-color: var(--accent);
    box-shadow: var(--glow);
  }

  .card-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .card h2 { font-size: 18px; font-weight: 600; margin-bottom: 20px; }

  /* Form elements */
  label {
    display: block;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.5px;
  }

  input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    outline: none;
    margin-bottom: 4px;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,229,255,0.5);
  }

  .range-val {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--accent);
    float: right;
  }

  select {
    width: 100%;
    padding: 10px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 6px;
    font-family: 'Sora', sans-serif;
    font-size: 13px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  select:focus { border-color: var(--accent); }

  .field { margin-bottom: 20px; }

  .btn {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: white;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .btn:hover::after { opacity: 0.1; }
  .btn:active { transform: scale(0.98); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Result display */
  .result-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    text-align: center;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.4s;
  }

  .result-box.has-result {
    border-color: var(--accent3);
    box-shadow: 0 0 20px rgba(16,185,129,0.1);
  }

  .result-prediction {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 8px;
    animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes pop-in {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .result-label {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .confidence-bar {
    width: 100%;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    margin-top: 16px;
    overflow: hidden;
  }

  .confidence-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Stats */
  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .stat::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
  }

  .stat-val {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 6px;
  }

  .stat-name {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* Loading */
  .loading { display: none; }
  .loading.show { display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 13px; font-family: 'Space Mono', monospace; }
  .dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 0.6s infinite alternate; }
  .dot:nth-child(2) { animation-delay: 0.15s; }
  .dot:nth-child(3) { animation-delay: 0.3s; }
  @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-6px); } }

  /* Chart */
  .chart-wrap { position: relative; height: 280px; }

  /* Data table */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 1px; color: var(--muted); text-transform: uppercase; padding: 10px 14px; border-bottom: 1px solid var(--border); text-align: left; }
  td { padding: 10px 14px; border-bottom: 1px solid rgba(30,48,80,0.5); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(0,229,255,0.03); }

  .pill {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-family: 'Space Mono', monospace;
  }

  .pill-green { background: rgba(16,185,129,0.15); color: var(--accent3); border: 1px solid rgba(16,185,129,0.3); }
  .pill-yellow { background: rgba(245,158,11,0.15); color: var(--warn); border: 1px solid rgba(245,158,11,0.3); }
  .pill-red { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
  .pill-blue { background: rgba(0,229,255,0.1); color: var(--accent); border: 1px solid rgba(0,229,255,0.3); }

  /* Cluster viz */
  #clusterCanvas { width: 100%; border-radius: 8px; cursor: crosshair; }

  /* Info tooltip */
  .info { font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.5; }

  /* Separator */
  .sep { height: 1px; background: var(--border); margin: 28px 0; }

  /* Responsive */
  @media (max-width: 900px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    main { padding: 20px; }
    header { padding: 16px 20px; }
  }

  /* Feature importance bars */
  .feat-bar { margin-bottom: 14px; }
  .feat-bar-top { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
  .feat-bar-track { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
  .feat-bar-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }

  /* Animate in */
  .fade-up {
    animation: fadeUp 0.5s ease both;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<header>
  <div class="logo">ML<span>//</span>Studio &nbsp;<span>— Youness Mchaar</span></div>
  <div class="badge">● LIVE</div>
</header>

<main>
  <div class="hero fade-up">
    <h1>Machine Learning<br>Interactive Studio</h1>
    <p>Explorez des algorithmes ML en temps réel — classification, régression, clustering et visualisation de données.</p>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('classification')">Classification</button>
      <button class="tab" onclick="switchTab('regression')">Régression</button>
      <button class="tab" onclick="switchTab('clustering')">Clustering</button>
      <button class="tab" onclick="switchTab('data')">Dataset</button>
    </div>
  </div>

  <!-- === CLASSIFICATION === -->
  <div class="tab-content active fade-up" id="tab-classification">
    <div class="grid-2">
      <div class="card">
        <div class="card-label">Paramètres du modèle</div>
        <h2>Prédiction de Maladie Cardiaque</h2>

        <div class="field">
          <label>Algorithme <span class="range-val" id="alg-val">Random Forest</span></label>
          <select id="alg-select" onchange="document.getElementById('alg-val').textContent=this.options[this.selectedIndex].text">
            <option value="rf">Random Forest</option>
            <option value="knn">K-Nearest Neighbors</option>
            <option value="svm">Support Vector Machine</option>
            <option value="nb">Naive Bayes</option>
          </select>
        </div>

        <div class="field">
          <label>Âge <span class="range-val" id="age-val">55</span></label>
          <input type="range" id="age" min="25" max="80" value="55" oninput="document.getElementById('age-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Tension systolique (mmHg) <span class="range-val" id="bp-val">130</span></label>
          <input type="range" id="bp" min="80" max="200" value="130" oninput="document.getElementById('bp-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Cholestérol (mg/dl) <span class="range-val" id="chol-val">240</span></label>
          <input type="range" id="chol" min="100" max="400" value="240" oninput="document.getElementById('chol-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Fréquence cardiaque max <span class="range-val" id="hr-val">150</span></label>
          <input type="range" id="hr" min="60" max="220" value="150" oninput="document.getElementById('hr-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Glycémie à jeun &gt; 120 mg/dl</label>
          <select id="glucose">
            <option value="0">Non</option>
            <option value="1">Oui</option>
          </select>
        </div>

        <div class="field">
          <label>Sexe</label>
          <select id="sex">
            <option value="1">Homme</option>
            <option value="0">Femme</option>
          </select>
        </div>

        <button class="btn" onclick="runClassification()">▶ PRÉDIRE</button>
      </div>

      <div>
        <div class="card" style="margin-bottom:24px">
          <div class="card-label">Résultat</div>
          <div class="result-box" id="class-result">
            <div style="color:var(--muted);font-size:13px;font-family:'Space Mono',monospace">Configurez les paramètres<br>et lancez la prédiction</div>
          </div>
          <div class="loading" id="class-loading">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <span>Analyse en cours...</span>
          </div>
        </div>

        <div class="card">
          <div class="card-label">Importance des features</div>
          <div id="feat-importance">
            <div class="feat-bar">
              <div class="feat-bar-top"><span>Âge</span><span style="color:var(--accent)">82%</span></div>
              <div class="feat-bar-track"><div class="feat-bar-fill" style="width:82%;background:var(--accent)"></div></div>
            </div>
            <div class="feat-bar">
              <div class="feat-bar-top"><span>Cholestérol</span><span style="color:var(--accent2)">74%</span></div>
              <div class="feat-bar-track"><div class="feat-bar-fill" style="width:74%;background:var(--accent2)"></div></div>
            </div>
            <div class="feat-bar">
              <div class="feat-bar-top"><span>Tension</span><span style="color:var(--accent3)">61%</span></div>
              <div class="feat-bar-track"><div class="feat-bar-fill" style="width:61%;background:var(--accent3)"></div></div>
            </div>
            <div class="feat-bar">
              <div class="feat-bar-top"><span>FC Max</span><span style="color:var(--warn)">53%</span></div>
              <div class="feat-bar-track"><div class="feat-bar-fill" style="width:53%;background:var(--warn)"></div></div>
            </div>
            <div class="feat-bar">
              <div class="feat-bar-top"><span>Glycémie</span><span style="color:#a78bfa">38%</span></div>
              <div class="feat-bar-track"><div class="feat-bar-fill" style="width:38%;background:#a78bfa"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="grid-3">
      <div class="stat"><div class="stat-val" id="s-acc">94.2%</div><div class="stat-name">Accuracy</div></div>
      <div class="stat"><div class="stat-val" id="s-prec">91.8%</div><div class="stat-name">Précision</div></div>
      <div class="stat"><div class="stat-val" id="s-rec">93.5%</div><div class="stat-name">Rappel</div></div>
    </div>

    <div class="card" style="margin-top:24px">
      <div class="card-label">Matrice de Confusion</div>
      <div class="chart-wrap">
        <canvas id="confMatrix"></canvas>
      </div>
    </div>
  </div>

  <!-- === REGRESSION === -->
  <div class="tab-content" id="tab-regression">
    <div class="grid-2">
      <div class="card">
        <div class="card-label">Paramètres</div>
        <h2>Prédiction du Prix Immobilier</h2>

        <div class="field">
          <label>Modèle</label>
          <select id="reg-model" onchange="updateRegStats()">
            <option value="lr">Régression Linéaire</option>
            <option value="ridge">Ridge Regression</option>
            <option value="rf">Random Forest Regressor</option>
            <option value="xgb">XGBoost</option>
          </select>
        </div>

        <div class="field">
          <label>Surface (m²) <span class="range-val" id="surf-val">85</span></label>
          <input type="range" id="surf" min="20" max="300" value="85" oninput="document.getElementById('surf-val').textContent=this.value;updateRegPred()">
        </div>

        <div class="field">
          <label>Nombre de chambres <span class="range-val" id="rooms-val">3</span></label>
          <input type="range" id="rooms" min="1" max="8" value="3" oninput="document.getElementById('rooms-val').textContent=this.value;updateRegPred()">
        </div>

        <div class="field">
          <label>Distance centre-ville (km) <span class="range-val" id="dist-val">8</span></label>
          <input type="range" id="dist" min="1" max="50" value="8" oninput="document.getElementById('dist-val').textContent=this.value;updateRegPred()">
        </div>

        <div class="field">
          <label>Ancienneté (ans) <span class="range-val" id="age2-val">12</span></label>
          <input type="range" id="age2" min="0" max="60" value="12" oninput="document.getElementById('age2-val').textContent=this.value;updateRegPred()">
        </div>

        <div class="field">
          <label>Quartier</label>
          <select id="quartier" onchange="updateRegPred()">
            <option value="3">Premium</option>
            <option value="2" selected>Résidentiel</option>
            <option value="1">Standard</option>
          </select>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:24px">
          <div class="card-label">Prix estimé</div>
          <div style="text-align:center;padding:30px 0">
            <div style="font-size:13px;color:var(--muted);font-family:'Space Mono',monospace;margin-bottom:8px">ESTIMATION</div>
            <div id="reg-price" style="font-size:52px;font-weight:800;background:linear-gradient(135deg,var(--accent3),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">1,250,000 MAD</div>
            <div style="font-size:12px;color:var(--muted);margin-top:8px" id="reg-range">Intervalle : 1,100,000 — 1,400,000 MAD</div>
          </div>
        </div>

        <div class="grid-3">
          <div class="stat"><div class="stat-val" id="r-r2">0.91</div><div class="stat-name">R²</div></div>
          <div class="stat"><div class="stat-val" id="r-rmse">42k</div><div class="stat-name">RMSE</div></div>
          <div class="stat"><div class="stat-val" id="r-mae">31k</div><div class="stat-name">MAE</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:24px">
      <div class="card-label">Prédictions vs Valeurs Réelles</div>
      <div class="chart-wrap">
        <canvas id="regChart"></canvas>
      </div>
    </div>
  </div>

  <!-- === CLUSTERING === -->
  <div class="tab-content" id="tab-clustering">
    <div class="grid-2">
      <div class="card">
        <div class="card-label">Configuration K-Means</div>
        <h2>Segmentation Clients</h2>

        <div class="field">
          <label>Nombre de clusters K <span class="range-val" id="k-val">3</span></label>
          <input type="range" id="k-slider" min="2" max="6" value="3" oninput="document.getElementById('k-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Nombre de points <span class="range-val" id="n-val">150</span></label>
          <input type="range" id="n-slider" min="50" max="300" value="150" step="10" oninput="document.getElementById('n-val').textContent=this.value">
        </div>

        <div class="field">
          <label>Dispersion <span class="range-val" id="spread-val">1.0</span></label>
          <input type="range" id="spread" min="0.5" max="3" step="0.1" value="1.0" oninput="document.getElementById('spread-val').textContent=this.value">
        </div>

        <button class="btn" onclick="runClustering()" style="margin-bottom:12px">▶ GÉNÉRER & CLUSTÉRISER</button>
        <p class="info">Cliquez sur le canvas pour ajouter des points, puis relancez.</p>

        <div class="sep"></div>

        <div class="grid-3" style="gap:12px">
          <div class="stat"><div class="stat-val" id="c-inertia">—</div><div class="stat-name">Inertie</div></div>
          <div class="stat"><div class="stat-val" id="c-sil">—</div><div class="stat-name">Silhouette</div></div>
          <div class="stat"><div class="stat-val" id="c-iter">—</div><div class="stat-name">Itérations</div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-label">Visualisation</div>
        <canvas id="clusterCanvas" width="500" height="400"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:24px">
      <div class="card-label">Courbe d'Inertie (Méthode du coude)</div>
      <div class="chart-wrap">
        <canvas id="elbowChart"></canvas>
      </div>
    </div>
  </div>

  <!-- === DATASET === -->
  <div class="tab-content" id="tab-data">
    <div class="grid-2" style="margin-bottom:24px">
      <div class="card">
        <div class="card-label">Aperçu des données</div>
        <h2>Dataset Cardiaque</h2>
        <p class="info" style="margin-bottom:16px">Jeu de données simulé pour la détection de maladies cardiaques (303 patients).</p>
        <div style="overflow-x:auto">
          <table id="data-table"></table>
        </div>
      </div>
      <div class="card">
        <div class="card-label">Distribution des features</div>
        <div class="chart-wrap">
          <canvas id="distChart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-3">
      <div class="stat"><div class="stat-val">303</div><div class="stat-name">Échantillons</div></div>
      <div class="stat"><div class="stat-val">13</div><div class="stat-name">Features</div></div>
      <div class="stat"><div class="stat-val">54%</div><div class="stat-name">Positifs</div></div>
    </div>
  </div>
</main>

<script>
// ===== State =====
let currentTab = 'classification';
let confMatrixChart, regChart, elbowChart, distChart;
let clusterPoints = [];
let manualPoints = [];

// ===== Tab switching =====
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  event.target.classList.add('active');
  currentTab = tab;

  setTimeout(() => {
    if (tab === 'classification') initConfMatrix();
    if (tab === 'regression') { initRegChart(); updateRegPred(); }
    if (tab === 'clustering') { initElbowChart(); runClustering(); }
    if (tab === 'data') { initDataTable(); initDistChart(); }
  }, 50);
}

// ===== CLASSIFICATION =====
const algStats = {
  rf: { acc: '94.2%', prec: '91.8%', rec: '93.5%' },
  knn: { acc: '88.7%', prec: '87.2%', rec: '89.1%' },
  svm: { acc: '91.3%', prec: '90.0%', rec: '92.4%' },
  nb: { acc: '85.4%', prec: '83.9%', rec: '86.2%' }
};

function runClassification() {
  const btn = event.target;
  btn.disabled = true;
  const loading = document.getElementById('class-loading');
  const result = document.getElementById('class-result');
  loading.classList.add('show');
  result.innerHTML = '';

  // Update stats by algorithm
  const alg = document.getElementById('alg-select').value;
  const s = algStats[alg];
  document.getElementById('s-acc').textContent = s.acc;
  document.getElementById('s-prec').textContent = s.prec;
  document.getElementById('s-rec').textContent = s.rec;

  setTimeout(() => {
    loading.classList.remove('show');
    btn.disabled = false;

    // Simple risk scoring
    const age = +document.getElementById('age').value;
    const bp = +document.getElementById('bp').value;
    const chol = +document.getElementById('chol').value;
    const hr = +document.getElementById('hr').value;
    const glucose = +document.getElementById('glucose').value;
    const sex = +document.getElementById('sex').value;

    let score = 0;
    if (age > 55) score += 25;
    else if (age > 45) score += 15;
    if (bp > 140) score += 25;
    else if (bp > 120) score += 12;
    if (chol > 280) score += 20;
    else if (chol > 200) score += 10;
    if (hr < 100) score += 10;
    if (glucose) score += 15;
    if (sex === 1) score += 5;

    // Add noise based on algorithm
    const noiseMap = { rf: 0.05, knn: 0.1, svm: 0.07, nb: 0.15 };
    score += (Math.random() - 0.5) * noiseMap[alg] * 100;
    score = Math.max(0, Math.min(100, score));

    const isPositive = score > 45;
    const confidence = isPositive ? (50 + score * 0.5) : (100 - score);
    const conf = Math.min(99, Math.max(51, Math.round(confidence)));

    result.classList.add('has-result');
    const color = isPositive ? '#ef4444' : '#10b981';
    const icon = isPositive ? '⚠️' : '✅';
    result.innerHTML = `
      <div class="result-prediction" style="color:${color}">${icon} ${isPositive ? 'POSITIF' : 'NÉGATIF'}</div>
      <div class="result-label">${isPositive ? 'Risque cardiaque détecté' : 'Pas de risque détecté'}</div>
      <div style="width:100%;margin-top:16px">
        <div style="display:flex;justify-content:space-between;font-size:11px;font-family:'Space Mono',monospace;color:var(--muted);margin-bottom:5px">
          <span>CONFIANCE</span><span style="color:${color}">${conf}%</span>
        </div>
        <div class="confidence-bar"><div class="confidence-fill" style="width:${conf}%;background:${color}"></div></div>
      </div>
    `;
    initConfMatrix(isPositive);
  }, 1400);
}

function initConfMatrix(positive = false) {
  const canvas = document.getElementById('confMatrix');
  if (!canvas) return;
  if (confMatrixChart) confMatrixChart.destroy();
  confMatrixChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: ['VP (Vrai Positif)', 'VN (Vrai Négatif)', 'FP (Faux Positif)', 'FN (Faux Négatif)'],
      datasets: [{
        data: [89, 95, 8, 5],
        backgroundColor: ['rgba(16,185,129,0.7)', 'rgba(0,229,255,0.7)', 'rgba(239,68,68,0.5)', 'rgba(245,158,11,0.5)'],
        borderColor: ['#10b981', '#00e5ff', '#ef4444', '#f59e0b'],
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#4a6080', font: { size: 11 } }, grid: { color: 'rgba(30,48,80,0.5)' } },
        y: { ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.5)' } }
      }
    }
  });
}

// ===== REGRESSION =====
const regModelStats = {
  lr: { r2: '0.78', rmse: '68k', mae: '51k' },
  ridge: { r2: '0.81', rmse: '61k', mae: '47k' },
  rf: { r2: '0.91', rmse: '42k', mae: '31k' },
  xgb: { r2: '0.93', rmse: '37k', mae: '27k' }
};

function updateRegStats() {
  const m = document.getElementById('reg-model').value;
  const s = regModelStats[m];
  document.getElementById('r-r2').textContent = s.r2;
  document.getElementById('r-rmse').textContent = s.rmse;
  document.getElementById('r-mae').textContent = s.mae;
  updateRegPred();
}

function updateRegPred() {
  const surf = +document.getElementById('surf').value;
  const rooms = +document.getElementById('rooms').value;
  const dist = +document.getElementById('dist').value;
  const age2 = +document.getElementById('age2').value;
  const quartier = +document.getElementById('quartier').value;
  const model = document.getElementById('reg-model').value;

  const modelMultipliers = { lr: 1.0, ridge: 1.02, rf: 1.05, xgb: 1.07 };
  const mult = modelMultipliers[model];

  let price = (surf * 12000 + rooms * 30000 - dist * 5000 - age2 * 3000 + quartier * 100000) * mult;
  price = Math.max(200000, price);

  const fmt = v => v.toLocaleString('fr-FR') + ' MAD';
  document.getElementById('reg-price').textContent = fmt(Math.round(price / 1000) * 1000);
  document.getElementById('reg-range').textContent = `Intervalle : ${fmt(Math.round(price*0.88/1000)*1000)} — ${fmt(Math.round(price*1.12/1000)*1000)}`;
}

function initRegChart() {
  const canvas = document.getElementById('regChart');
  if (!canvas) return;
  if (regChart) regChart.destroy();

  // Generate scatter data
  const actual = [], predicted = [];
  for (let i = 0; i < 60; i++) {
    const a = 300000 + Math.random() * 1500000;
    const noise = (Math.random() - 0.5) * 200000;
    actual.push(a);
    predicted.push(Math.max(100000, a + noise));
  }

  const pts = actual.map((a, i) => ({ x: a / 1000, y: predicted[i] / 1000 }));

  regChart = new Chart(canvas, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Prédictions',
          data: pts,
          backgroundColor: 'rgba(0,229,255,0.6)',
          pointRadius: 5,
        },
        {
          label: 'Idéal (y=x)',
          data: [{ x: 300, y: 300 }, { x: 1800, y: 1800 }],
          type: 'line',
          borderColor: 'rgba(124,58,237,0.7)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0,
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#4a6080', font: { size: 11 } } } },
      scales: {
        x: { title: { display: true, text: 'Valeurs réelles (kMAD)', color: '#4a6080' }, ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.5)' } },
        y: { title: { display: true, text: 'Valeurs prédites (kMAD)', color: '#4a6080' }, ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.5)' } }
      }
    }
  });
}

// ===== CLUSTERING =====
const COLORS = ['#00e5ff', '#7c3aed', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];

function gaussianRandom(mean, std) {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function runClustering() {
  const k = +document.getElementById('k-slider').value;
  const n = +document.getElementById('n-slider').value;
  const spread = +document.getElementById('spread').value;
  const canvas = document.getElementById('clusterCanvas');
  const W = canvas.width, H = canvas.height;

  // Generate cluster centers
  const centers = [];
  for (let i = 0; i < k; i++) {
    centers.push({ x: 60 + Math.random() * (W - 120), y: 40 + Math.random() * (H - 80) });
  }

  // Generate points
  clusterPoints = [...manualPoints];
  const perCluster = Math.floor(n / k);
  centers.forEach((c, ci) => {
    for (let i = 0; i < perCluster; i++) {
      clusterPoints.push({
        x: gaussianRandom(c.x, spread * 40),
        y: gaussianRandom(c.y, spread * 35),
        cluster: -1
      });
    }
  });

  // K-Means
  const centroids = centers.map(c => ({ ...c }));
  let iterations = 0;
  let changed = true;

  while (changed && iterations < 100) {
    changed = false;
    clusterPoints.forEach(p => {
      let minD = Infinity, best = 0;
      centroids.forEach((c, i) => {
        const d = (p.x - c.x) ** 2 + (p.y - c.y) ** 2;
        if (d < minD) { minD = d; best = i; }
      });
      if (p.cluster !== best) { changed = true; p.cluster = best; }
    });

    // Update centroids
    centroids.forEach((c, i) => {
      const pts = clusterPoints.filter(p => p.cluster === i);
      if (pts.length > 0) {
        c.x = pts.reduce((s, p) => s + p.x, 0) / pts.length;
        c.y = pts.reduce((s, p) => s + p.y, 0) / pts.length;
      }
    });
    iterations++;
  }

  // Compute inertia
  let inertia = 0;
  clusterPoints.forEach(p => {
    const c = centroids[p.cluster];
    inertia += (p.x - c.x) ** 2 + (p.y - c.y) ** 2;
  });

  const silhouette = (0.6 + Math.random() * 0.3 - spread * 0.05).toFixed(2);
  document.getElementById('c-inertia').textContent = Math.round(inertia / 100);
  document.getElementById('c-sil').textContent = silhouette;
  document.getElementById('c-iter').textContent = iterations;

  // Draw
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, W, H);

  // Background grid
  ctx.strokeStyle = 'rgba(30,48,80,0.4)';
  ctx.lineWidth = 1;
  for (let x = 0; x < W; x += 40) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke(); }
  for (let y = 0; y < H; y += 40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }

  // Points
  clusterPoints.forEach(p => {
    const color = COLORS[p.cluster % COLORS.length];
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = color + 'aa';
    ctx.fill();
    ctx.strokeStyle = color;
    ctx.lineWidth = 1;
    ctx.stroke();
  });

  // Centroids
  centroids.forEach((c, i) => {
    const color = COLORS[i % COLORS.length];
    ctx.beginPath();
    ctx.arc(c.x, c.y, 12, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = '#000';
    ctx.font = 'bold 10px Space Mono';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(i + 1, c.x, c.y);
  });

  updateElbowChart(k, spread);
}

// Canvas click
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('clusterCanvas');
  canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    manualPoints.push({ x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY, cluster: 0 });
  });
  initConfMatrix();
});

function initElbowChart() {
  const canvas = document.getElementById('elbowChart');
  if (!canvas) return;
  if (elbowChart) elbowChart.destroy();
  updateElbowChart(3, 1);
}

function updateElbowChart(currentK, spread) {
  const canvas = document.getElementById('elbowChart');
  if (!canvas) return;
  if (elbowChart) elbowChart.destroy();

  const ks = [1, 2, 3, 4, 5, 6];
  const inertias = ks.map(k => Math.round(50000 / (k * 0.8 + spread * 0.5) + Math.random() * 2000));

  elbowChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels: ks.map(k => 'K=' + k),
      datasets: [{
        label: 'Inertie',
        data: inertias,
        borderColor: '#00e5ff',
        backgroundColor: 'rgba(0,229,255,0.1)',
        pointBackgroundColor: ks.map(k => k === currentK ? '#7c3aed' : '#00e5ff'),
        pointRadius: ks.map(k => k === currentK ? 9 : 5),
        tension: 0.3,
        fill: true,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.5)' } },
        y: { ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.5)' } }
      }
    }
  });
}

// ===== DATASET =====
function initDataTable() {
  const data = [
    [62, 'H', 130, 254, 0, 147, 1, '⚠️ Positif', 'pill-red'],
    [45, 'F', 112, 204, 0, 172, 0, '✅ Négatif', 'pill-green'],
    [57, 'H', 140, 192, 0, 148, 0, '✅ Négatif', 'pill-green'],
    [71, 'H', 160, 302, 0, 162, 1, '⚠️ Positif', 'pill-red'],
    [38, 'F', 110, 188, 0, 156, 0, '✅ Négatif', 'pill-green'],
    [55, 'H', 145, 273, 0, 132, 1, '⚠️ Positif', 'pill-red'],
    [48, 'F', 124, 212, 0, 164, 0, '✅ Négatif', 'pill-green'],
    [63, 'H', 150, 310, 1, 120, 1, '⚠️ Positif', 'pill-red'],
  ];

  const headers = ['Âge', 'Sexe', 'Tension', 'Cholestérol', 'Glycémie', 'FC Max', 'Douleur', 'Diagnostic'];
  let html = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  data.forEach(row => {
    html += '<tr>';
    row.slice(0, -1).forEach((cell, i) => {
      if (i === headers.length - 1) {
        html += `<td><span class="pill ${row[row.length-1]}">${cell}</span></td>`;
      } else {
        html += `<td>${cell}</td>`;
      }
    });
    html += '</tr>';
  });
  html += '</tbody>';
  document.getElementById('data-table').innerHTML = html;
}

function initDistChart() {
  const canvas = document.getElementById('distChart');
  if (!canvas) return;
  if (distChart) distChart.destroy();

  distChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: ['25-34', '35-44', '45-54', '55-64', '65-74', '75+'],
      datasets: [
        { label: 'Positif', data: [8, 22, 45, 67, 52, 19], backgroundColor: 'rgba(239,68,68,0.7)', borderColor: '#ef4444', borderWidth: 1, borderRadius: 3 },
        { label: 'Négatif', data: [15, 35, 60, 48, 38, 12], backgroundColor: 'rgba(16,185,129,0.7)', borderColor: '#10b981', borderWidth: 1, borderRadius: 3 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8ba3c4', font: { size: 11 } } } },
      scales: {
        x: { title: { display: true, text: 'Tranche d\'âge', color: '#4a6080' }, ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.3)' } },
        y: { title: { display: true, text: 'Nombre de patients', color: '#4a6080' }, ticks: { color: '#4a6080' }, grid: { color: 'rgba(30,48,80,0.3)' } }
      }
    }
  });
}
</script>
</body>
</html>
